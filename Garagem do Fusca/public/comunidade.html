<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="./css/comunidade.css" />
  <title>Nova Postagem</title>

</head>

<body>

  <main>

    <div class="form-posts">
      <h1>Nova Postagem</h1>

      <div class="campos-form">
        <label for="titulo">Título</label>
        <input name="titulo" id="titulo" type="text" placeholder="Título do post" />
      </div>

      <div class="campos-form">
        <label for="descricao">Descrição</label>
        <input name="descricao" id="descricao" type="text" placeholder="Descrição do post" />
      </div>

      <div class="campos-form">
        <label for="imagem">Imagem</label>
        <input name="imagem" id="imagem" type="file" onchange="mostrarPreview()" />
      </div>

      <img id="preview" src="#" />

      <button type="button" onclick="enviar()">Enviar</button>
    </div>

    <div class="div_msg" id="div_msg"></div>

  </main>

  <script>
    function mostrarPreview() {
      const input = document.getElementById('imagem');
      const preview = document.getElementById('preview');

      if (input.files && input.files[0]) {
        const reader = new FileReader();

        reader.onload = function (e) {
          preview.src = e.target.result;
          preview.style.display = 'block';
        }

        reader.readAsDataURL(input.files[0]);
      }
    }

    function enviar() {
      const formData = new FormData();
      formData.append('titulo', titulo.value);
      formData.append('descricao', descricao.value);
      formData.append('imagem', imagem.files[0]);

      const id_usuario = sessionStorage.ID_USUARIO;
      if (!id_usuario) {
        alert("Usuário não autenticado.");
        return;
      }

      formData.append('fk_usuario', id_usuario);

      fetch("/posts/cadastro", {
        method: "POST",
        body: formData
      })
        .then(res => res.text())
        .then(msg => {
          alert(msg);
          carregarPostagens(); // atualiza postagens após envio
        })
        .catch(err => console.log(err));
    }

    function carregarPostagens() {
      fetch("/posts/listar")
        .then(res => res.json())
        .then(postagens => {
          const container = document.getElementById("div_msg");
          container.innerHTML = "";

          for (let i = postagens.length - 1; i >= 0; i--) {
            const post = postagens[i];
            container.innerHTML +=
              `
      <div class="post" id="post">
      <h4>@${post.nome}</h4>
      <div class="post-img">
        <img src="/public/assets/imgs_postagens/${post.url_imagem}" alt="Imagem do post">
      </div>

      <span class="titulo">${post.titulo}</span><br>
      <span class="descricao">${post.descricao}</span><br>
      <span class="data">${post.dt_postagem}</span>

    </div>   
              `;
          }
        })
        .catch(err => {
          console.error("Erro ao carregar postagens:", err);
        });
    }

    // Carrega postagens ao abrir a página
    window.onload = carregarPostagens;
  </script>
</body>

</html>